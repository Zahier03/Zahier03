<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>Visual Script Editor for Google Apps Script</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100vh;
    }
    
    /* Main layout */
    .container {
      display: grid;
      grid-template-columns: 250px 1fr 300px;
      grid-template-rows: 40px 1fr 200px;
      height: 100vh;
    }
    
    /* Header */
    .header {
      grid-column: 1 / 4;
      grid-row: 1;
      background-color: #2c3e50;
      color: white;
      display: flex;
      align-items: center;
      padding: 0 10px;
    }
    
    .header h1 {
      font-size: 18px;
      margin: 0;
      flex-grow: 1;
    }
    
    .header-buttons {
      display: flex;
      gap: 5px;
    }
    
    .header-buttons button {
      background-color: #3498db;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
    }
    
    .header-buttons button:hover {
      background-color: #2980b9;
    }
    
    /* Library panel */
    .library-panel {
      grid-column: 1;
      grid-row: 2;
      background-color: #ecf0f1;
      border-right: 1px solid #bdc3c7;
      overflow-y: auto;
      padding: 10px;
    }
    
    .library-section {
      margin-bottom: 15px;
    }
    
    .library-section h2 {
      font-size: 16px;
      margin: 0 0 5px 0;
      padding-bottom: 5px;
      border-bottom: 1px solid #bdc3c7;
    }
    
    .library-item {
      background-color: #fff;
      border: 1px solid #ddd;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 3px;
      cursor: grab;
      transition: background-color 0.2s;
    }
    
    .library-item:hover {
      background-color: #f5f5f5;
    }
    
    /* Canvas */
    .canvas-container {
      grid-column: 2;
      grid-row: 2;
      background-color: #fff;
      position: relative;
      overflow: auto;
    }
    
    .canvas {
      position: absolute;
      width: 5000px;
      height: 5000px;
      background-image: linear-gradient(#f0f0f0 1px, transparent 1px),
                        linear-gradient(90deg, #f0f0f0 1px, transparent 1px);
      background-size: 20px 20px;
    }
    
    /* Properties panel */
    .properties-panel {
      grid-column: 3;
      grid-row: 2;
      background-color: #ecf0f1;
      border-left: 1px solid #bdc3c7;
      padding: 10px;
      overflow-y: auto;
    }
    
    .properties-panel h2 {
      font-size: 16px;
      margin: 0 0 10px 0;
      padding-bottom: 5px;
      border-bottom: 1px solid #bdc3c7;
    }
    
    .property-row {
      display: flex;
      margin-bottom: 5px;
      align-items: center;
    }
    
    .property-label {
      width: 100px;
      font-size: 14px;
    }
    
    .property-value {
      flex-grow: 1;
    }
    
    .property-value input, .property-value select {
      width: 100%;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 3px;
    }
    
    /* Code panel */
    .code-panel {
      grid-column: 1 / 4;
      grid-row: 3;
      background-color: #2c3e50;
      color: white;
      border-top: 1px solid #bdc3c7;
      display: flex;
      flex-direction: column;
    }
    
    .code-header {
      padding: 5px 10px;
      background-color: #34495e;
      display: flex;
      align-items: center;
    }
    
    .code-header h2 {
      font-size: 14px;
      margin: 0;
      flex-grow: 1;
    }
    
    .code-content {
      flex-grow: 1;
      overflow: auto;
      padding: 10px;
      font-family: monospace;
      background-color: #1e272e;
      color: #ecf0f1;
    }
    
    /* Block styles */
    .block {
      position: absolute;
      min-width: 150px;
      background-color: #3498db;
      border-radius: 5px;
      padding: 10px;
      color: white;
      cursor: move;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1;
    }
    
    .block .block-header {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .block .block-content {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .block input {
      background-color: rgba(255,255,255,0.9);
      border: none;
      padding: 5px;
      border-radius: 3px;
    }
    
    .block-connector {
      width: 10px;
      height: 10px;
      background-color: orange;
      border-radius: 50%;
      position: absolute;
      cursor: pointer;
    }
    
    .input-connector {
      top: -5px;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .output-connector {
      bottom: -5px;
      left: 50%;
      transform: translateX(-50%);
    }
    
    /* Connection line */
    .connection-line {
      position: absolute;
      background-color: orange;
      height: 2px;
      transform-origin: 0 0;
      z-index: 0;
    }
    
    /* HTML Component styles */
    .html-component {
      position: absolute;
      background-color: white;
      border: 1px solid #ddd;
      min-width: 50px;
      min-height: 20px;
      z-index: 1;
      cursor: move;
    }
    
    /* Tabs */
    .tab-container {
      padding: 5px;
    }
    
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #bdc3c7;
    }
    
    .tab-button {
      padding: 5px 10px;
      margin-right: 5px;
      background-color: #ecf0f1;
      border: 1px solid #bdc3c7;
      border-bottom: none;
      border-radius: 5px 5px 0 0;
      cursor: pointer;
    }
    
    .tab-button.active {
      background-color: #3498db;
      color: white;
    }
    
    .tab-content {
      display: none;
      padding: 10px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Resizable components */
    .ui-resizable-handle {
      position: absolute;
      width: 8px;
      height: 8px;
      background-color: #3498db;
      border: 1px solid white;
    }
    
    .ui-resizable-se {
      bottom: -4px;
      right: -4px;
      cursor: se-resize;
    }
    
    /* Color picker */
    .color-preview {
      width: 20px;
      height: 20px;
      border: 1px solid #ddd;
      display: inline-block;
      vertical-align: middle;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>Visual Script Editor for Google Apps Script</h1>
      <div class="header-buttons">
        <button id="newProjectBtn"><i class="fas fa-file"></i> New</button>
        <button id="saveBtn"><i class="fas fa-save"></i> Save</button>
        <button id="exportBtn"><i class="fas fa-file-export"></i> Export Code</button>
        <button id="runBtn"><i class="fas fa-play"></i> Run</button>
      </div>
    </div>
    
    <!-- Library Panel -->
    <div class="library-panel">
      <div class="tab-container">
        <div class="tab-buttons">
          <div class="tab-button active" data-tab="blocksTab">Blocks</div>
          <div class="tab-button" data-tab="htmlTab">HTML</div>
        </div>
        
        <div id="blocksTab" class="tab-content active">
          <div class="library-section">
            <h2>Spreadsheet</h2>
            <div class="library-items" id="spreadsheetItems">
              <!-- Will be populated dynamically -->
            </div>
          </div>
          
          <div class="library-section">
            <h2>UI</h2>
            <div class="library-items" id="uiItems">
              <!-- Will be populated dynamically -->
            </div>
          </div>
          
          <div class="library-section">
            <h2>Control Flow</h2>
            <div class="library-items" id="flowItems">
              <!-- Will be populated dynamically -->
            </div>
          </div>
          
          <div class="library-section">
            <h2>Utilities</h2>
            <div class="library-items" id="utilsItems">
              <!-- Will be populated dynamically -->
            </div>
          </div>
        </div>
        
        <div id="htmlTab" class="tab-content">
          <div class="library-section">
            <h2>UI Components</h2>
            <div class="library-items" id="htmlComponents">
              <!-- Will be populated dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Canvas -->
    <div class="canvas-container">
      <div class="canvas" id="canvas"></div>
    </div>
    
    <!-- Properties Panel -->
    <div class="properties-panel">
      <h2>Properties</h2>
      <div id="propertiesContent">
        <p>Select a block or component to edit its properties.</p>
      </div>
    </div>
    
    <!-- Code Panel -->
    <div class="code-panel">
      <div class="code-header">
        <h2>Generated Code</h2>
        <button id="refreshCodeBtn"><i class="fas fa-sync"></i> Refresh</button>
        <button id="copyCodeBtn"><i class="fas fa-copy"></i> Copy</button>
      </div>
      <div class="code-content" id="codeContent">
        // Generated code will appear here
      </div>
    </div>
  </div>
  
  <!-- JavaScript libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  
  <script>
    // Global variables
    let blocks = [];
    let connections = [];
    let htmlComponents = [];
    let selectedElement = null;
    let isDraggingConnection = false;
    let tempConnection = null;
    let startConnector = null;
    let availableFunctions = {};
    let availableHtmlComponents = [];
    
    // Main initialization function
    function initializeEditor() {
      // Fetch available functions from server
      google.script.run.withSuccessHandler(function(data) {
        availableFunctions = data;
        populateBlockLibrary();
      }).getAvailableFunctions();
      
      // Fetch available HTML components
      google.script.run.withSuccessHandler(function(data) {
        availableHtmlComponents = data;
        populateHtmlComponentLibrary();
      }).getHtmlComponents();
      
      // Set up the canvas for dragging and connections
      setupCanvas();
      
      // Set up tab switching
      setupTabs();
      
      // Set up button handlers
      setupButtons();
    }
    
    // Populate the block library with available functions
    function populateBlockLibrary() {
      // Clear existing items
      $('#spreadsheetItems, #uiItems, #flowItems, #utilsItems').empty();
      
      // Add items for each category
      for (let category in availableFunctions) {
        const items = availableFunctions[category].functions;
        const categoryId = category + 'Items';
        
        items.forEach(function(item) {
          const $item = $('<div class="library-item" data-category="' + category + '" data-name="' + item.name + '">' + 
                         item.name + '</div>');
          $('#' + categoryId).append($item);
        });
      }
      
      // Make library items draggable
      $('.library-item').draggable({
        helper: 'clone',
        appendTo: 'body',
        start: function(event, ui) {
          $(ui.helper).css('z-index', '1000');
        }
      });
    }
    
    // Populate the HTML component library
    function populateHtmlComponentLibrary() {
      // Clear existing items
      $('#htmlComponents').empty();
      
      // Add items for each HTML component
      availableHtmlComponents.forEach(function(component) {
        const $item = $('<div class="library-item" data-type="html" data-component="' + component.type + '">' + 
                       component.name + '</div>');
        $('#htmlComponents').append($item);
      });
      
      // Make HTML components draggable
      $('#htmlComponents .library-item').draggable({
        helper: 'clone',
        appendTo: 'body',
        start: function(event, ui) {
          $(ui.helper).css('z-index', '1000');
        }
      });
    }
    
    // Set up the canvas for handling drops and interactions
    function setupCanvas() {
      const $canvas = $('#canvas');
      
      // Make the canvas a drop target for blocks
      $canvas.droppable({
        accept: '.library-item',
        drop: function(event, ui) {
          const offset = $canvas.offset();
          const x = ui.offset.left - offset.left;
          const y = ui.offset.top - offset.top;
          
          // Check if this is an HTML component or a code block
          if ($(ui.helper).data('type') === 'html') {
            createHtmlComponent($(ui.helper).data('component'), x, y);
          } else {
            createBlock($(ui.helper).data('category'), $(ui.helper).data('name'), x, y);
          }
        }
      });
      
      // Handle canvas panning (middle mouse button)
      let isPanning = false;
      let startPanX, startPanY, startScrollX, startScrollY;
      
      $canvas.parent().on('mousedown', function(e) {
        if (e.which === 2) { // Middle mouse button
          isPanning = true;
          startPanX = e.pageX;
          startPanY = e.pageY;
          startScrollX = $(this).scrollLeft();
          startScrollY = $(this).scrollTop();
          e.preventDefault();
        }
      });
      
      $(document).on('mousemove', function(e) {
        if (isPanning) {
          const $container = $canvas.parent();
          $container.scrollLeft(startScrollX - (e.pageX - startPanX));
          $container.scrollTop(startScrollY - (e.pageY - startPanY));
        }
      });
      
      $(document).on('mouseup', function() {
        isPanning = false;
      });
    }
    
    // Set up tab switching
    function setupTabs() {
      $('.tab-button').click(function() {
        const tabId = $(this).data('tab');
        
        // Deactivate all tabs
        $('.tab-button').removeClass('active');
        $('.tab-content').removeClass('active');
        
        // Activate selected tab
        $(this).addClass('active');
        $('#' + tabId).addClass('active');
      });
    }
    
    // Set up button handlers
    function setupButtons() {
      // New project button
      $('#newProjectBtn').click(function() {
        if (confirm('Create a new project? All unsaved changes will be lost.')) {
          blocks = [];
          connections = [];
          htmlComponents = [];
          $('#canvas').empty();
          refreshCode();
        }
      });
      
      // Save button
      $('#saveBtn').click(function() {
        saveProject();
      });
      
      // Export code button
      $('#exportBtn').click(function() {
        exportCode();
      });
      
      // Run button
      $('#runBtn').click(function() {
        alert('Run functionality would execute the script in the Apps Script environment.');
      });
      
      // Refresh code button
      $('#refreshCodeBtn').click(function() {
        refreshCode();
      });
      
      // Copy code button
      $('#copyCodeBtn').click(function() {
        const code = $('#codeContent').text();
        navigator.clipboard.writeText(code).then(function() {
          alert('Code copied to clipboard!');
        });
      });
    }
    
    // Create a new block on the canvas
    function createBlock(category, name, x, y) {
      const blockId = 'block_' + new Date().getTime();
      const blockType = category + '.' + name;
      
      // Find the function definition
      const funcDef = availableFunctions[category].functions.find(f => f.name === name);
      
      // Create block HTML
      const $block = $('<div class="block" id="' + blockId + '" data-type="' + blockType + '"></div>');
      $block.css({
        'left': x + 'px',
        'top': y + 'px',
        'background-color': getCategoryColor(category)
      });
      
      // Block header
      $block.append('<div class="block-header">' + name + '</div>');
      
      // Block content with parameter inputs
      const $content = $('<div class="block-content"></div>');
      
      if (funcDef.params && funcDef.params.length > 0) {
        funcDef.params.forEach(function(param) {
          $content.append('<div><span>' + param + ':</span> <input type="text" data-param="' + param + '"></div>');
        });
      }
      
      $block.append($content);
      
      // Add connectors
      $block.append('<div class="block-connector input-connector" data-connector="input"></div>');
      $block.append('<div class="block-connector output-connector" data-connector="output"></div>');
      
      // Add to canvas
      $('#canvas').append($block);
      
      // Make block draggable
      $block.draggable({
        containment: 'parent',
        handle: '.block-header',
        drag: function() {
          updateConnections();
        }
      });
      
      // Store block data
      blocks.push({
        id: blockId,
        type: blockType,
        x: x,
        y: y,
        params: {}
      });
      
      // Set up block interactions
      setupBlockInteractions($block);
      
      // Return the created block
      return $block;
    }
    
    // Create an HTML component on the canvas
    function createHtmlComponent(componentType, x, y) {
      const componentId = 'component_' + new Date().getTime();
      
      // Find the component definition
      const compDef = availableHtmlComponents.find(c => c.type === componentType);
      
      if (!compDef) return;
      
      // Create the HTML component
      let $component;
      
      switch (componentType) {
        case 'div':
          $component = $('<div class="html-component" id="' + componentId + '" data-type="' + componentType + '"></div>');
          $component.text('Container');
          break;
        case 'button':
          $component = $('<button class="html-component" id="' + componentId + '" data-type="' + componentType + '">Click Me</button>');
          break;
        case 'input':
          $component = $('<input type="text" class="html-component" id="' + componentId + '" data-type="' + componentType + '" placeholder="Enter text...">');
          break;
        case 'select':
          $component = $('<select class="html-component" id="' + componentId + '" data-type="' + componentType + '"></select>');
          for (let i = 1; i <= 3; i++) {
            $component.append('<option>Option ' + i + '</option>');
          }
          break;
        case 'table':
          $component = $('<table class="html-component" id="' + componentId + '" data-type="' + componentType + '"></table>');
          for (let i = 0; i < 3; i++) {
            const $row = $('<tr></tr>');
            for (let j = 0; j < 3; j++) {
              $row.append('<td>Cell</td>');
            }
            $component.append($row);
          }
          break;
        case 'label':
          $component = $('<label class="html-component" id="' + componentId + '" data-type="' + componentType + '">Text Label</label>');
          break;
        default:
          $component = $('<div class="html-component" id="' + componentId + '" data-type="' + componentType + '"></div>');
      }
      
      // Set position and apply default properties
      $component.css({
        'left': x + 'px',
        'top': y + 'px'
      });
      
      // Apply default styles from the component definition
      if (compDef.properties) {
        for (let prop in compDef.properties) {
          $component.css(prop, compDef.properties[prop]);
        }
      }
      
      // Add to canvas
      $('#canvas').append($component);
      
      // Make component draggable
      $component.draggable({
        containment: 'parent'
      });
      
      // Make component resizable
      $component.resizable({
        handles: 'se',
        minWidth: 50,
        minHeight: 20
      });
      
      // Store component data
      htmlComponents.push({
        id: componentId,
        type: componentType,
        x: x,
        y: y,
        properties: compDef.properties || {}
      });
      
      // Set up component interactions
      setupComponentInteractions($component);
      
      // Return the created component
      return $component;
    }
    
    // Set up interactions for blocks
    function setupBlockInteractions($block) {
      // Select block on click
      $block.on('click', function(e) {
        selectElement($(this));
        e.stopPropagation();
      });
      
      // Update parameters when inputs change
      $block.find('input').on('change', function() {
        const blockId = $block.attr('id');
        const blockIdx = blocks.findIndex(b => b.id === blockId);
        const param = $(this).data('param');
        const value = $(this).val();
        
        if (blockIdx >= 0) {
          blocks[blockIdx].params[param] = value;
          refreshCode();
        }
      });
      
      // Handle connection drag/drop
      $block.find('.block-connector').on('mousedown', function(e) {
        startConnector = {
          blockId: $block.attr('id'),
          type: $(this).data('connector'),
          x: $block.offset().left + $(this).position().left + 5,
          y: $block.offset().top + $(this).position().top + 5
        };
        
        isDraggingConnection = true;
        e.stopPropagation();
      });
    }
    
    // Set up interactions for HTML components
    function setupComponentInteractions($component) {
      // Select component on click
      $component.on('click', function(e) {
        selectElement($(this));
        e.stopPropagation();
      });
    }
    
    // Handle selecting an element
    function selectElement($element) {
      // Deselect previous element
      if (selectedElement) {
        selectedElement.removeClass('selected');
      }
      
      // Select new element
      selectedElement = $element;
      selectedElement.addClass('selected');
      
      // Show properties
      if ($element.hasClass('block')) {
        showBlockProperties($element);
      } else if ($element.hasClass('html-component')) {
        showComponentProperties($element);
      }
    }
    
    // Show properties for a selected block
    function showBlockProperties($block) {
      const blockId = $block.attr('id');
      const blockType = $block.data('type');
      const [category, name] = blockType.split('.');
      
      // Find the function definition
      const funcDef = availableFunctions[category].functions.find(f => f.name === name);
      
      // Build properties form
      let html = '<div class="property-row">' +
                '<div class="property-label">Type:</div>' +
                '<div class="property-value">' + blockType + '</div>' +
                '</div>';
      
      html += '<div class="property-row">' +
              '<div class="property-label">Description:</div>' +
              '<div class="property-value">' + funcDef.description + '</div>' +
              '</div>';
      
      // Parameters
      if (funcDef.params && funcDef.params.length > 0) {
        funcDef.params.forEach(function(param) {
          const value = blocks.find(b => b.id === blockId)?.params[param] || '';
          
          html += '<div class="property-row">' +
                  '<div class="property-label">' + param + ':</div>' +
                  '<div class="property-value">' +
                  '<input type="text" data-param="' + param + '" value="' + value + '">' +
                  '</div></div>';
        });
      } else {
        html += '<div>No configurable parameters</div>';
      }
      
      // Set content
      $('#propertiesContent').html(html);
      
      // Set up events
      $('#propertiesContent input').on('change', function() {
        const blockIdx = blocks.findIndex(b => b.id === blockId);
        const param = $(this).data('param');
        const value = $(this).val();
        
        if (blockIdx >= 0) {
          blocks[blockIdx].params[param] = value;
          $block.find('input[data-param="' + param + '"]').val(value);
          refreshCode();
        }
      });
    }
    
    // Show properties for a selected HTML component
    function showComponentProperties($component) {
      const componentId = $component.attr('id');
      const componentType = $component.data('type');
      
      // Find the component data
      const componentIdx = htmlComponents.findIndex(c => c.id === componentId);
      const componentData = htmlComponents[componentIdx];
      
      if (!componentData) return;
      
      // Build properties form
      let html = '<div class="property-row">' +
                '<div class="property-label">Type:</div>' +
                '<div class="property-value">' + componentType + '</div>' +
                '</div>';
      
      // Common style properties
      const styleProps = [
        { name: 'width', label: 'Width', type: 'text' },
        { name: 'height', label: 'Height', type: 'text' },
        { name: 'backgroundColor', label: 'Background', type: 'color' },
        { name: 'color', label: 'Text Color', type: 'color' },
        { name: 'fontSize', label: 'Font Size', type: 'text' },
        { name: 'padding', label: 'Padding', type: 'text' },
        { name: 'borderRadius', label: 'Border Radius', type: 'text' }
      ];
      
      styleProps.forEach(function(prop) {
        const value = $component.css(prop.name);
        
        html += '<div class="property-row">' +
                '<div class="property-label">' + prop.label + ':</div>' +
                '<div class="property-value">';
        
        if (prop.type === 'color') {
          html += '<input type="text" data-style="' + prop.name + '" value="' + value + '">' +
                  '<div class="color-preview" style="background-color: ' + value + '"></div>';
        } else {
          html += '<input type="text" data-style="' + prop.name + '" value="' + value + '">';
        }
        
        html += '</div></div>';
      });
      
      // Component specific properties
      if (componentType === 'button' || componentType === 'label') {
        html += '<div class="property-row">' +
                '<div class="property-label">Text:</div>' +
                '<div class="property-value">' +
                '<input type="text" data-prop="text" value="' + $component.text() + '">' +
                '</div></div>';
      } else if (componentType === 'input') {
        html += '<div class="property-row">' +
                '<div class="property-label">Placeholder:</div>' +
                '<div class="property-value">' +
                '<input type="text" data-prop="placeholder" value="' + $component.attr('placeholder') + '">' +
                '</div></div>';
      }
      
      // Set content
      $('#propertiesContent').html(html);
      
      // Set up events for style properties
      $('#propertiesContent input[data-style]').on('change', function() {
        const propName = $(this).data('style');
        const value = $(this).val();
        
        // Update component style
        $component.css(propName, value);
        
        // Update color preview if needed
        if (propName === 'backgroundColor' || propName === 'color') {
          $(this).siblings('.color-preview').css('background-color', value);
        }
        
        // Update component data
        if (componentIdx >= 0) {
          componentData.properties[propName] = value;
        }
      });
      
      // Set up events for component-specific properties
      $('#propertiesContent input[data-prop]').on('change', function() {
        const propName = $(this).data('prop');
        const value = $(this).val();
        
        // Update component
        if (propName === 'text') {
          $component.text(value);
        } else if (propName === 'placeholder') {
          $component.attr('placeholder', value);
        }
        
        // Update component data
        if (componentIdx >= 0) {
          componentData.properties[propName] = value;
        }
      });
    }
    
    // Update connection lines between blocks
    function updateConnections() {
      $('.connection-line').remove();
      
      connections.forEach(function(conn) {
        drawConnection(conn.source, conn.target);
      });
    }
    
    // Draw a connection line between two blocks
    function drawConnection(sourceId, targetId) {
      const $source = $('#' + sourceId);
      const $target = $('#' + targetId);
      
      if ($source.length === 0 || $target.length === 0) return;
      
      const $canvas = $('#canvas');
      const canvasOffset = $canvas.offset();
      
      const $sourceConnector = $source.find('.output-connector');
      const $targetConnector = $target.find('.input-connector');
      
      const sourceX = $source.offset().left - canvasOffset.left + $sourceConnector.position().left + 5;
      const sourceY = $source.offset().top - canvasOffset.top + $sourceConnector.position().top + 5;
      
      const targetX = $target.offset().left - canvasOffset.left + $targetConnector.position().left + 5;
      const targetY = $target.offset().top - canvasOffset.top + $targetConnector.position().top + 5;
      
      // Calculate line properties
      const dx = targetX - sourceX;
      const dy = targetY - sourceY;
      const length = Math.sqrt(dx * dx + dy * dy);
      const angle = Math.atan2(dy, dx) * 180 / Math.PI;
      
      // Create line element
      const $line = $('<div class="connection-line"></div>');
      $line.css({
        'left': sourceX + 'px',
        'top': sourceY + 'px',
        'width': length + 'px',
        'transform': 'rotate(' + angle + 'deg)'
      });
      
      // Add to canvas
      $canvas.append($line);
    }
    
    // Get color for different block categories
    function getCategoryColor(category) {
      const colors = {
        'spreadsheet': '#2ecc71',
        'ui': '#e74c3c',
        'flow': '#3498db',
        'utilities': '#f39c12'
      };
      
      return colors[category] || '#3498db';
    }
    
    // Generate and display the code
    function refreshCode() {
      // Build block structure for code generation
      const blockStructure = {
        functions: {
          'main': {
            name: 'main',
            parameters: [],
            blocks: blocks.map(block => ({
              type: block.type,
              params: block.params
            }))
          }
        }
      };
      
      // Generate HTML components code
      let htmlCode = '// HTML Components\n';
      htmlComponents.forEach(comp => {
        htmlCode += 'const ' + comp.id + ' = document.createElement("' + comp.type + '");\n';
        for (let prop in comp.properties) {
          htmlCode += comp.id + '.style.' + prop + ' = "' + comp.properties[prop] + '";\n';
        }
        htmlCode += '\n';
      });
      
      // Call server-side code generation
      google.script.run.withSuccessHandler(function(result) {
        $('#codeContent').text(htmlCode + '\n' + result);
      }).generateCode(blockStructure);
    }
    
    // Save the current project
    function saveProject() {
      const projectData = {
        blocks: blocks,
        connections: connections,
        htmlComponents: htmlComponents
      };
      
      // In a real implementation, you would save this to a file or database
      alert('Project saved! (In a real implementation, this would be saved to a file or database)');
    }
    
    // Export the generated code
    function exportCode() {
      const code = $('#codeContent').text();
      
      // Call server-side export function
      google.script.run.withSuccessHandler(function(result) {
        if (result.success) {
          alert(result.message);
        } else {
          alert('Error exporting code: ' + result.message);
        }
      }).saveAsNewProject(code, 'Visual Script Project');
    }
    
    // Handle document-level events
    $(document).ready(function() {
      // Initialize editor
      initializeEditor();
      
      // Handle document mouseup for connections
      $(document).on('mouseup', function() {
        if (isDraggingConnection) {
          isDraggingConnection = false;
          
          // Remove temporary connection line
          if (tempConnection) {
            tempConnection.remove();
            tempConnection = null;
          }
        }
      });
      
      // Handle document mousemove for connections
      $(document).on('mousemove', function(e) {
        if (isDraggingConnection) {
          // Remove previous temporary line
          if (tempConnection) {
            tempConnection.remove();
          }
          
          // Draw new temporary line
          const $canvas = $('#canvas');
          const canvasOffset = $canvas.offset();
          
          const endX = e.pageX - canvasOffset.left;
          const endY = e.pageY - canvasOffset.top;
          
          // Calculate line properties
          const dx = endX - startConnector.x;
          const dy = endY - startConnector.y;
          const length = Math.sqrt(dx * dx + dy * dy);
          const angle = Math.atan2(dy, dx) * 180 / Math.PI;
          
          // Create temporary line
          tempConnection = $('<div class="connection-line"></div>');
          tempConnection.css({
            'left': startConnector.x + 'px',
            'top': startConnector.y + 'px',
            'width': length + 'px',
            'transform': 'rotate(' + angle + 'deg)',
            'opacity': '0.5'
          });
          
          $canvas.append(tempConnection);
        }
      });
      
      // Close connections when clicking on canvas background
      $('#canvas').on('click', function(e) {
        if ($(e.target).is('#canvas')) {
          if (selectedElement) {
            selectedElement.removeClass('selected');
            selectedElement = null;
            $('#propertiesContent').html('<p>Select a block or component to edit its properties.</p>');
          }
        }
      });
    });
  </script>
</body>
</html>
